<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Cartografía audiovisual de la viñatería rural del Valle del Itata</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    #app { display: flex; flex-direction: column; height: 100%; }

    header { padding:.6rem 1rem; border-bottom:1px solid #e5e7eb; background:#fff; z-index:1000; }
    header h1 { font-size:1rem; margin:0; font-weight:700; }
    header .meta { font-size:.8rem; color:#64748b; }

    .layout { display:flex; flex:1; overflow:hidden; }
    .panel { width:300px; border-right:1px solid #e5e7eb; padding:1rem; overflow-y:auto; background:#fafafa; }
    #map { flex:1; height:100%; }

    .tag { display:inline-block; padding:.2rem .5rem; margin:.15rem; border-radius:999px; font-size:.8rem; background:#e2e8f0; cursor:pointer; }
    .tag.active { background:#0ea5e9; color:#fff; }
    .search { width:100%; padding:.5rem .6rem; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:.8rem; }
    .popup h3 { margin:.2rem 0 .4rem 0; font-size:1rem; }
    .popup p { margin:.2rem 0; font-size:.9rem; }
    .popup .meta { font-size:.8rem; color:#64748b; }
    .legend { font-size:.8rem; color:#64748b; margin-top:1rem; }
    .credits { font-size:.75rem; color:#94a3b8; margin-top:1.2rem; }
    .btn { display:inline-block; padding:.4rem .6rem; border:1px solid #e5e7eb; border-radius:8px; background:#fff; cursor:pointer; font-size:.85rem; }
    .btn:hover { background:#f8fafc; }

    /* Contenedores responsive */
    .yt-portrait, .yt-landscape {
      position:relative; width:100%; margin:.6rem auto; max-width:560px; background:#000; border-radius:8px; overflow:hidden;
    }
    .yt-portrait::before { content:""; display:block; padding-top:177.78%; } /* 9:16 */
    .yt-landscape::before { content:""; display:block; padding-top:56.25%; }  /* 16:9 */
    .yt-portrait iframe, .yt-landscape iframe { position:absolute; inset:0; width:100%; height:100%; border:0; }

    @media (max-width: 768px) {
      .layout { flex-direction:column; }
      .panel { width:100%; max-height:220px; border-right:none; border-bottom:1px solid #e5e7eb; }
      #map { flex:1; height:calc(100% - 220px); }
    }
  </style>
</head>
<body>
<div id="app">
  <header>
    <h1>Cartografía audiovisual de la viñatería rural del Valle del Itata</h1>
    <div class="meta">Puntos con audio y video. Filtra por etiquetas o busca por palabras.</div>
  </header>

  <div class="layout">
    <aside class="panel">
      <input id="q" class="search" placeholder="Buscar por título, autor o descripción…" />
      <h2>Filtrar por etiquetas</h2>
      <div id="tags"></div>
      <div class="legend">
        • Clic en un marcador para abrir el medio (audio/video).<br/>
        • Usa <span class="btn" id="fit">Ajustar vista</span> para encuadrar los puntos visibles.
      </div>
      <div class="credits">Edita <code>data.json</code> para agregar tus puntos del Itata.</div>
    </aside>
    <main id="map"></main>
  </div>
</div>

<script>
// Capas
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap' });
const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom:19, attribution:'Tiles © Esri, Maxar, Earthstar Geographics' });

const map = L.map('map', { layers:[esri], scrollWheelZoom:true }).setView([-36.7,-72.5], 11);
L.control.layers({ "Satélite (Esri)": esri, "Mapa (OSM)": osm }).addTo(map);

const markers = L.markerClusterGroup();
const layerAll = L.layerGroup().addTo(map);

let PUNTOS = [];
let activeTags = new Set();

/* Normalizador de YouTube */
function toYoutubeEmbedInfo(url){
  try{
    const u = new URL(url);
    let id = "", isShort = false;

    if (u.hostname.includes("youtu.be")) {
      id = u.pathname.slice(1);
    } else if (u.hostname.includes("youtube") && u.pathname.startsWith("/shorts/")) {
      id = u.pathname.split("/shorts/")[1].split("/")[0];
      isShort = true;
    } else if (u.hostname.includes("youtube") && u.pathname === "/watch") {
      id = u.searchParams.get("v") || "";
    } else if (u.hostname.includes("youtube") && u.pathname.startsWith("/embed/")) {
      id = u.pathname.split("/embed/")[1].split("/")[0];
    }

    if (!id) return null;
    const base = "https://www.youtube-nocookie.com/embed/" + id;
    const params = "?rel=0&modestbranding=1&playsinline=1";
    return { src: base + params, isShortGuess: isShort };
  }catch(e){ return null; }
}

function mediaBlock(p){
  if (p.video_url){
    const info = toYoutubeEmbedInfo(p.video_url);
    if (info){
      const isShort = (p.short === true) || info.isShortGuess === true;
      const klass = isShort ? 'yt-portrait' : 'yt-landscape';
      return `
        <div class="${klass}">
          <iframe
            src="${info.src}"
            title="YouTube video"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
            loading="lazy"
            referrerpolicy="origin-when-cross-origin"></iframe>
        </div>`;
    }
  }
  if (p.audio_url){
    return `<audio controls preload="none" style="width:100%">
              <source src="${p.audio_url}" type="audio/mpeg">
            </audio>`;
  }
  return `<div class="meta">Sin medio adjunto</div>`;
}

// Cargar datos
fetch('data.json')
  .then(r => r.json())
  .then(data => { PUNTOS = data; buildTagUI(); render(); })
  .catch(err => console.error('Error cargando data.json', err));

function buildTagUI(){
  const all = Array.from(new Set(PUNTOS.flatMap(p => p.etiquetas || []))).sort();
  const div = document.getElementById('tags');
  div.innerHTML = '';
  all.forEach(t => {
    const el = document.createElement('span');
    el.className = 'tag';
    el.textContent = t;
    el.onclick = () => { activeTags.has(t) ? activeTags.delete(t) : activeTags.add(t); el.classList.toggle('active'); render(); };
    div.appendChild(el);
  });
}

const q = document.getElementById('q');
q.addEventListener('input', render);

function render(){
  markers.clearLayers(); layerAll.clearLayers();
  const text = q.value.trim().toLowerCase();

  const filtered = PUNTOS.filter(p => {
    const textOk = !text || ((p.titulo||'')+' '+(p.autor||'')+' '+(p.descripcion||'')).toLowerCase().includes(text);
    const tagsOk = activeTags.size===0 || (p.etiquetas||[]).some(t => activeTags.has(t));
    return textOk && tagsOk;
  });

  filtered.forEach(p => {
    const m = L.marker([p.lat, p.lng]);
    const popup = `
      <div class="popup">
        <h3>${p.titulo||'Sin título'}</h3>
        <div class="meta">${(p.autor||'Autor desconocido')} · ${(p.fecha||'s/f')} · ${(p.etiquetas||[]).map(t=>'#'+t).join(' ')}</div>
        <p>${p.descripcion||''}</p>
        ${mediaBlock(p)}
      </div>`;
    m.bindPopup(popup, { maxWidth: 440, keepInView: true });
    markers.addLayer(m);
  });

  layerAll.addLayer(markers);
  if (filtered.length){
    const bounds = L.latLngBounds(filtered.map(p => [p.lat, p.lng]));
    map.fitBounds(bounds.pad(0.2));
  }
}

document.getElementById('fit').onclick = () => {
  const pts = [];
  markers.eachLayer(m => pts.push(m.getLatLng()));
  if (pts.length) map.fitBounds(L.latLngBounds(pts).pad(0.2));
};
</script>
</body>
</html>
