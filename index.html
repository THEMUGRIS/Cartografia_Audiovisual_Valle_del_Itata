<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cartografía audiovisual de la viñatería rural del Valle del Itata</title>

  <!-- Leaflet + MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    #app { display: grid; grid-template-rows: auto 1fr; height: 100%; }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: .6rem 1rem; border-bottom: 1px solid #e5e7eb; background: #fff; position: sticky; top: 0; z-index: 999;
    }
    header h1 { font-size: 1rem; margin: 0; font-weight: 700; }
    header .meta { font-size: .85rem; color: #64748b; }
    .layout { display: grid; grid-template-columns: 300px 1fr; height: 100%; }
    .panel { border-right: 1px solid #e5e7eb; padding: 1rem; overflow: auto; background: #fafafa; }
    .panel h2 { font-size: .95rem; margin: .2rem 0 .6rem 0; }
    .tag { display: inline-block; padding: .2rem .5rem; margin: .15rem; border-radius: 999px; font-size: .8rem; background: #e2e8f0; cursor: pointer; }
    .tag.active { background: #0ea5e9; color: white; }
    .search { width: 100%; padding: .5rem .6rem; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: .8rem; }
    #map { width: 100%; height: 100%; }
    .popup h3 { margin:.2rem 0 .4rem 0; font-size: 1rem; }
    .popup p  { margin:.2rem 0; font-size: .9rem; }
    .popup .meta { font-size: .8rem; color:#64748b; }
    .legend { font-size: .8rem; color: #64748b; margin-top: 1rem; }
    .credits { font-size: .75rem; color:#94a3b8; margin-top: 1.2rem; }
    .btn { display:inline-block; padding:.4rem .6rem; border:1px solid #e5e7eb; border-radius:8px; background:#fff; cursor:pointer; font-size:.85rem; }
    .btn:hover { background:#f8fafc; }
    video, audio { outline: none; }

    /* ===== Mobile ===== */
    @media (max-width: 768px) {
      .layout { display: block; }
      .panel {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
        padding: 0.8rem;
      }
      #map { height: 70vh; }
      header h1 { font-size: 0.9rem; }
    }
  </style>
</head>
<body>
<div id="app">
  <header>
    <h1>Cartografía audiovisual de la viñatería rural del Valle del Itata</h1>
    <div class="meta">Puntos con audio y video. Filtra por etiquetas o busca por palabras.</div>
  </header>
  <div class="layout">
    <aside class="panel">
      <input id="q" class="search" placeholder="Buscar por título, autor o descripción…" />
      <h2>Filtrar por etiquetas</h2>
      <div id="tags"></div>
      <div class="legend">
        • Clic en un marcador para abrir el medio (audio/video).<br/>
        • Usa <span class="btn" id="fit">Ajustar vista</span> para encuadrar los puntos visibles.
      </div>
      <div class="credits">
        Edita <code>data.json</code> para agregar tus puntos del Itata.
      </div>
    </aside>
    <main id="map"></main>
  </div>
</div>

<script>
// ===== Capas base =====
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap'
});

const esriSat = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  {
    maxZoom: 19,
    attribution: 'Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics'
  }
);

// Crear el mapa aquí ANTES de addTo()
const map = L.map('map', { scrollWheelZoom: true, layers: [esriSat] });
map.setView([-36.7, -72.5], 11);

// Switch de capas
L.control.layers({ "Satélite (Esri)": esriSat, "Mapa (OSM)": osm }).addTo(map);

// ===== Marcadores y lógica =====
const markers = L.markerClusterGroup();
const layerAll = L.layerGroup().addTo(map);

let PUNTOS = [];
let activeTags = new Set();

// Cargar puntos desde data.json
fetch('data.json')
  .then(r => r.json())
  .then(data => {
    PUNTOS = Array.isArray(data) ? data : [];
    buildTagUI();
    render();
  })
  .catch(err => console.error('Error cargando data.json', err));

// ===== UI etiquetas únicas =====
function buildTagUI(){
  const allTags = Array.from(new Set(PUNTOS.flatMap(p => p.etiquetas || []))).sort();
  const tagsDiv = document.getElementById('tags');
  tagsDiv.innerHTML = "";
  allTags.forEach(tag => {
    const el = document.createElement('span');
    el.className = 'tag';
    el.textContent = tag;
    el.onclick = () => { 
      if (activeTags.has(tag)) activeTags.delete(tag); else activeTags.add(tag);
      el.classList.toggle('active');
      render();
    };
    tagsDiv.appendChild(el);
  });
}

// ===== Buscar por texto =====
const q = document.getElementById('q');
q.addEventListener('input', render);

// ===== Helpers de YouTube (incluye Shorts) =====
function toYoutubeEmbed(url){
  try {
    const u = new URL(url);
    if (u.hostname.includes('youtu.be')) {
      const id = u.pathname.slice(1);
      return `https://www.youtube.com/embed/${id}`;
    }
    if (u.hostname.includes('youtube.com')) {
      const v = u.searchParams.get('v');
      if (v) return `https://www.youtube.com/embed/${v}`;
      if (u.pathname.includes('/embed/')) return url;
      if (u.pathname.includes('/shorts/')) {
        const id = u.pathname.split('/shorts/')[1].split('?')[0];
        return `https://www.youtube.com/embed/${id}`;
      }
    }
    return url;
  } catch { return url; }
}

// ===== Bloque de medios (YouTube, Shorts, MP4 o audio) =====
function mediaBlock(p){
  if (p.video_url) {
    const v = String(p.video_url).trim();
    if (v.startsWith('<iframe')) {
      return v;
    }
    if (v.includes('youtu.be') || v.includes('youtube.com')) {
      const src = toYoutubeEmbed(v);
      return `<iframe width="100%" height="220" src="${src}" frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen></iframe>`;
    }
    return `
      <video controls preload="metadata" style="width:100%; max-height:260px">
        <source src="${v}" type="video/mp4">
        Tu navegador no soporta video HTML5.
      </video>`;
  }
  if (p.audio_url) {
    return `
      <audio controls preload="none" style="width:100%">
        <source src="${p.audio_url}" type="audio/mpeg">
        Tu navegador no soporta audio HTML5.
      </audio>`;
  }
  return `<div class="meta">Sin medio adjunto</div>`;
}

// ===== Pintar marcadores =====
function render() {
  markers.clearLayers();
  layerAll.clearLayers();

  const text = q.value.trim().toLowerCase();
  const filtered = PUNTOS.filter(p => {
    const textOk = !text || ((p.titulo||"")+' '+(p.autor||"")+' '+(p.descripcion||"")).toLowerCase().includes(text);
    const tagsOk = activeTags.size === 0 || (p.etiquetas||[]).some(t => activeTags.has(t));
    return textOk && tagsOk;
  });

  filtered.forEach(p => {
    const m = L.marker([p.lat, p.lng]);
    const popup = `
      <div class="popup">
        <h3>${p.titulo||"Sin título"}</h3>
        <div class="meta">${(p.autor||"Autor desconocido")} · ${(p.fecha||"s/f")} · ${(p.etiquetas||[]).map(t=>\`#\${t}\`).join(' ')}</div>
        <p>${p.descripcion||""}</p>
        ${mediaBlock(p)}
      </div>`;
    m.bindPopup(popup, { maxWidth: 380 });
    markers.addLayer(m);
  });

  layerAll.addLayer(markers);

  if (filtered.length) {
    const bounds = L.latLngBounds(filtered.map(p => [p.lat, p.lng]));
    map.fitBounds(bounds.pad(0.2));
  }
}

// Botón “Ajustar vista”
document.getElementById('fit').onclick = () => {
  const visible = [];
  markers.eachLayer(m => visible.push(m.getLatLng()));
  if (visible.length) map.fitBounds(L.latLngBounds(visible).pad(0.2));
};
</script>
</body>
</html>
